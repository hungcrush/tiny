/*global tinymce:true */

tinymce.PluginManager.add('image', function(editor, url) {
	function showDialog() {
		var win3, data, dom = editor.dom, imgElm = editor.selection.getNode();
		var width, height, query_str = "";

		if(imgElm.nodeName == "IMG" && !imgElm.getAttribute('data-mce-object')){
			var src = dom.getAttrib(imgElm, "src");
				if(src.substr(0, 4) != 'http' && src.substr(0, 2) == '//') src = 'http:'+src;
			query_str = "?title=" + dom.getAttrib(imgElm, 'title') + "&alt=" + dom.getAttrib(imgElm, 'alt') + "&width=" + dom.getAttrib(imgElm, 'width') + "&height=" + dom.getAttrib(imgElm, 'height') + "&src=" + encodeURIComponent(src);
			if(dom.getStyle(imgElm, 'float')){
				query_str += "&align=" + dom.getStyle(imgElm, 'float');
			}
		}else{
			imgElm = null;
		}

		function GetTheHtml(){
			var html = '';
			if(imgElm){
				var src = dom.getAttrib(imgElm, "src");
				if(src.substr(0, 4) != 'http' && src.substr(0, 2) == '//') src = 'http:'+src;

				html += '<input type="hidden" name="src" id="src" value="' + src + '"/>';
				html += '<input type="hidden" name="alt" id="alt" value="' + dom.getAttrib(imgElm, "alt") + '"/>';
				html += '<input type="hidden" name="title" id="title" value="' + dom.getAttrib(imgElm, "title") + '"/>';
				html += '<input type="hidden" name="width_" id="width_" value="' + dom.getAttrib(imgElm, "width") + '"/>';
				html += '<input type="hidden" name="height_" id="height_" value="' + dom.getAttrib(imgElm, "height") + '"/>';
				html += '<input type="hidden" name="linkURL" id="linkURL" />';
				html += '<input type="hidden" name="target" id="target" />';
				html += '<input type="hidden" name="align" id="align" value="' + dom.getStyle(imgElm, 'float') + '"/>';
				var respon = 0;
				if(dom.getAttrib(imgElm, "class") == 'img-responsive') respon = 1;
				html += '<input type="hidden" name="responsive" id="responsive" value="' + respon + '" />';
				
				var thumbnail = 0;
				if(dom.getParent(imgElm, 'a') != null && dom.getAttrib(dom.getParent(imgElm, 'a'), 'class') == 'thumbnail'){
					thumbnail = 1;
				}
				html += '<input type="hidden" name="thumbnail" id="thumbnail" value="' + thumbnail + '" />';
				html += '<iframe src="'+ url + '/image.php'+ query_str + '&' + new Date().getTime() + '" frameborder="0"></iframe>';
			}else{
				html += '<input type="hidden" name="src" id="src" />';
				html += '<input type="hidden" name="alt" id="alt" />';
				html += '<input type="hidden" name="title" id="title" />';
				html += '<input type="hidden" name="width_" id="width_" />';
				html += '<input type="hidden" name="height_" id="height_" />';
				html += '<input type="hidden" name="linkURL" id="linkURL" />';
				html += '<input type="hidden" name="target" id="target" />';
				html += '<input type="hidden" name="align" id="align" />';
				html += '<input type="hidden" name="responsive" id="responsive" />';
				html += '<input type="hidden" name="thumbnail" id="thumbnail" />';
				html += '<iframe src="'+ url + '/image.php'+ '?' + new Date().getTime() + '" frameborder="0"></iframe>';
			}
			
			
			return html;
		}
		
		function BuildDom(src, alt, w, h, title, linkURL, target, float, res, thumb){
			if(imgElm){
				if(src){
					dom.setStyle(imgElm, 'float', float);
					
					dom.setAttribs(imgElm, {
						'src': src,
						'alt': alt ? alt : null,
						'width': w ? w : null,
						'height': h ? h : null,
						'title': title ? title : null,
						'class': res == 1 ? 'img-responsive' : null
					});
					
					if(res == 1){
						dom.setStyle(imgElm, 'display', 'block');
						dom.setStyle(imgElm, 'width', '100%');
					}else{
						dom.setStyle(imgElm, 'display', null);
						dom.setStyle(imgElm, 'width', null);
					}
					
					if(thumb == 1){
						if(dom.getParent(imgElm, 'a') != null){
							dom.setAttribs(dom.getParent(imgElm, 'a'), {
								'class' : 'thumbnail'
							});
						}else{
							var linkAttrs = {
								href: 'javascript:void(0)',
								target: null,
								rel: 'thumbnail',
								"class": 'thumbnail',
								title: 'Thumbnail'
							};
							editor.execCommand('mceInsertLink', false, linkAttrs);
							
						}
					}else{
						
						if(dom.getParent(imgElm, 'a') != null){
							dom.setAttribs(dom.getParent(imgElm, 'a'), {
								'class' : null
							});
						}
					}
					
					
				}
			}else{
				var markup = '';
				if(src){
					markup += '<img src="' + src + '"';
					if(alt){
						markup += ' alt="' + alt + '"';
					}
					if(title){
						markup += ' title="' + title + '"';
					}
					if(h){
						markup += ' height="' + h + '"';
					}
					if(w){
						markup += ' width="' + w + '"';
					}
					
					if(res == 1){
						markup += ' class="img-responsive"';
						markup += ' style="display: block; width: 100%;"';
					}
					
					if(float){
						if(!linkURL){
							markup += ' style="float: ' + float + '"';
						}
					}
					
					markup += ' />';
					
					if(linkURL){
						var thelink = '<a href="' + linkURL + '"';
						
						if(thumb == 1){
							thelink += ' class="thumbnail"';
						}
						
						if(target){
							thelink += ' target="' + target + '"';
						}
						
						if(float){
							thelink += ' style="float: ' + float + '"';
						}
						
						thelink += '>';
						markup = thelink + markup + '</a>';
					}else if(thumb == 1){
						var thelink = '<a class="thumbnail" href="javascript:void(0)">';
						markup = thelink + markup + '</a>';
					}
				
					editor.insertContent(markup);
				}
			}
		}

		win3 = editor.windowManager.open({
			title: "Manage Image (BVN)",
			width : 1024,
			height : 475,
			html: GetTheHtml(),
			buttons: [
				{
				text: 'Insert Image',
				subtype: 'primary',
				onclick: function(e) {
					BuildDom(document.getElementById("src").value, 
							document.getElementById("alt").value, 
							document.getElementById("width_").value, 
							document.getElementById("height_").value, 
							document.getElementById("title").value,
							document.getElementById("linkURL").value,
							document.getElementById("target").value,
							document.getElementById("align").value,
							document.getElementById("responsive").value,
							document.getElementById("thumbnail").value);
					this.parent().parent().close();
				}
				},	
				{
				text: 'Cancel',
				onclick: function() {
					this.parent().parent().close();
				}
			}]
		});
	}
	
	editor.addButton('image', {
		icon: 'image',
		tooltip: 'Insert/edit image',
		onclick: showDialog,
		stateSelector: 'img:not([data-mce-object])'
	});

	editor.addMenuItem('image', {
		icon: 'image',
		text: 'Insert image',
		onclick: showDialog,
		context: 'insert',
		prependToContext: true
	});
});
